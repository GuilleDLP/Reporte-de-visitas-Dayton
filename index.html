<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Servicio - Dayton</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <!-- jsPDF desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Sistema de autenticaci√≥n -->
    <script src="./auth.js" defer></script>
    <!-- Panel de administrador -->
    <script src="./admin-panel.js" defer></script>
    <!-- Sistema de sincronizaci√≥n Firebase -->
    <script src="./firebase-sync.js" defer></script>
    <!-- Sincronizaci√≥n de usuarios con Firebase -->
    <script src="./firebase-users.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .header-left {
            text-align: left;
        }
        
        .header-right {
            text-align: right;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info span {
            font-weight: 500;
            color: #ecf0f1;
        }
        
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .form-container {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }
        
        button {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            color: white;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 5px;
        }
        
        .sync-status-bar {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 8px;
            padding: 12px 20px;
            margin: 15px 0;
            border-left: 4px solid #4caf50;
        }
        
        .sync-status-bar.warning {
            background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%);
            border-left-color: #ff9800;
        }
        
        .sync-status-bar.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left-color: #f44336;
        }
        
        .sync-status-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #syncStatusText {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .sync-badge {
            background: #4caf50;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .sync-badge.warning {
            background: #ff9800;
        }
        
        .sync-badge.error {
            background: #f44336;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .reporte-preview {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: none;
        }
        
        .reporte-preview h3 {
            color: #2c3e50;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .reporte-content {
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
            color: #333;
            font-size: 16px;
        }
        
        .saved-reports {
            margin-top: 30px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 8px;
        }
        
        .saved-reports h3 {
            color: #2c3e50;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .reports-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .search-filters {
            margin-bottom: 20px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
        }
        
        .search-filters h4 {
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .search-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            align-items: end;
        }
        
        .search-input, .filter-select {
            padding: 10px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .search-input:focus, .filter-select:focus {
            outline: none;
            border-color: #17a2b8;
            box-shadow: 0 0 0 2px rgba(23, 162, 184, 0.1);
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #e1e8ed;
            font-style: italic;
        }
        
        .report-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .report-item:hover {
            background: #f0f8ff;
            transform: translateX(5px);
        }
        
        .report-item strong {
            font-size: 16px;
            color: #2c3e50;
        }
        
        .report-item small {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .report-actions {
            margin-top: 10px;
        }
        
        /* Mensajes de confirmaci√≥n */
        .message {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 16px;
            font-weight: 500;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-style: italic;
        }
        
        /* Responsive improvements */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            button {
                padding: 12px 20px;
                font-size: 16px;
            }
            
            .reports-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .reports-actions {
                justify-content: center;
            }
            
            .search-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    
        .acciones {
            margin-top: 10px;
        }
        .acciones button {
            margin-right: 10px;
        }

        .footer-leyenda {
            margin-top: 50px;
            padding: 15px;
            text-align: center;
            font-size: 12px;
            color: #555;
            background-color: #f1f1f1;
            font-style: italic;
            border-top: 1px solid #ddd;
        }

        .form-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .form-section:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Contenedor para opciones horizontales */
        .opciones-horizontal {
            display: flex;
            gap: 25px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        /* Contenedor individual para cada opci√≥n */
        .opcion {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .opcion:hover {
            background-color: #e9ecef;
        }

        /* Estilos para radio buttons y checkboxes */
        .form-section input[type="radio"],
        .form-section input[type="checkbox"] {
            width: auto;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: #667eea;
        }

        /* Labels para radio buttons y checkboxes */
        .form-section .opcion label {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
            line-height: 1.2;
        }

        /* Estilo especial para checkboxes individuales */
        .checkbox-individual {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 12px 15px;
            background-color: #f8f9fa;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-individual:hover {
            background-color: #e9ecef;
        }

        .checkbox-individual:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-individual input[type="checkbox"] {
            width: auto;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-individual label {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
            flex: 1;
        }

        /* Campos condicionales */
        .campo-condicional {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .campo-condicional label {
            font-size: 14px;
            margin-bottom: 8px;
            color: #495057;
        }

        .campo-condicional input,
        .campo-condicional select,
        .campo-condicional textarea {
            font-size: 14px;
            padding: 10px 12px;
        }

        /* Responsive para opciones */
        @media (max-width: 600px) {
            .opciones-horizontal {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .opcion {
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Reportes de Servicio</h1>
                <p>University of Dayton Publishing</p>
            </div>
            <div class="header-right" id="userInfo" style="display: none;">
                <div class="user-info">
                    <span id="userName"></span>
                    <button class="btn-logout" onclick="cerrarSesion()">üö™ Salir</button>
                </div>
            </div>
        </div>
        
        <div class="form-container">
            <div id="messages"></div>
            
            <form id="visitaForm">
                <div class="form-group">
                    <label for="colegio">Colegio</label>
                    <input type="text" id="colegio" name="colegio" required list="colegiosDatalist" autocomplete="off">
                    <datalist id="colegiosDatalist"></datalist>
                </div>

                <div class="form-group">
                    <label>¬øEs usuario?</label>
                    <div class="form-section">
                        <div class="opciones-horizontal">
                            <div class="opcion">
                                <input type="radio" name="esUsuario" id="usuario_si" value="S√≠">
                                <label for="usuario_si">S√≠</label>
                            </div>
                            <div class="opcion">
                                <input type="radio" name="esUsuario" id="usuario_no" value="No">
                                <label for="usuario_no">No</label>
                            </div>
                        </div>

                        <div id="detalleUsuario" class="campo-condicional" style="display:none;">
                            <label for="detalleUsuarioInput">¬øDe qu√© producto o l√≠nea?</label>
                            <input type="text" id="detalleUsuarioInput" placeholder="Especificar producto o l√≠nea">
                        </div>

                        <div id="detalleCompetencia" class="campo-condicional" style="display:none;">
                            <label for="detalleCompetenciaInput">¬øQu√© competencia utiliza?</label>
                            <input type="text" id="detalleCompetenciaInput" placeholder="Nombre de editorial o producto">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="gerencia">Gerencia</label>
                        <select id="gerencia" name="gerencia" required onchange="actualizarZonas()">
                            <option value="">Seleccionar gerencia</option>
                            <option value="Baj√≠o">Baj√≠o</option>
                            <option value="Centro-Norte">Centro-Norte</option>
                            <option value="Centro-Sur">Centro-Sur</option>
                            <option value="Norte">Norte</option>
                            <option value="Occidente">Occidente</option>
                            <option value="Oriente">Oriente</option>
                            <option value="Pac√≠fico">Pac√≠fico</option>
                            <option value="Sur">Sur</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="zona">Zona Comercial</label>
                        <select id="zona" name="zona" required>
                            <option value="">Primero selecciona una gerencia</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="fecha">Fecha de Visita</label>
                        <input type="date" id="fecha" name="fecha" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="objetivo">Objetivo de la Visita</label>
                        <select id="objetivo" name="objetivo" required onchange="mostrarCampoOtroObjetivo()">
                            <option value="">Seleccionar objetivo</option>
                            <option value="Presentaci√≥n inicial">Presentaci√≥n inicial</option>
                            <option value="Seguimiento comercial">Seguimiento comercial</option>
                            <option value="Demostraci√≥n de producto">Demostraci√≥n de producto</option>
                            <option value="Capacitaci√≥n">Capacitaci√≥n</option>
                            <option value="Resoluci√≥n de dudas">Resoluci√≥n de dudas</option>
                            <option value="Renovaci√≥n de contrato">Renovaci√≥n de contrato</option>
                            <option value="Otro">Otro</option>
                        </select>
                        <div id="otroObjetivoContainer" style="display: none; margin-top: 10px;">
                            <label for="otroObjetivo">Especificar otro objetivo:</label>
                            <input type="text" id="otroObjetivo" name="otroObjetivo" placeholder="Describe el objetivo espec√≠fico...">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Datos de Contacto</label>
                    <div class="form-row">
                        <div>
                            <label for="nombreContacto">Nombre</label>
                            <input type="text" id="nombreContacto" name="nombreContacto" required>
                        </div>
                        <div>
                            <label for="cargoContacto">Cargo</label>
                            <input type="text" id="cargoContacto" name="cargoContacto" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label for="telefonoContacto">Tel√©fono</label>
                            <input type="tel" id="telefonoContacto" name="telefonoContacto" required 
                                   placeholder="555-123-4567 o 5551234567"
                                   onblur="formatearTelefono(this)">
                        </div>
                        <div>
                            <label for="correoContacto">Correo electr√≥nico</label>
                            <input type="email" id="correoContacto" name="correoContacto" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productos">Productos Presentados/Servicios Otorgados</label>
                    <textarea id="productos" name="productos" placeholder="Describe los libros, niveles, o servicios que presentaste..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="notas">Notas Relevantes</label>
                    <textarea id="notas" name="notas" placeholder="Observaciones importantes, reacciones del cliente, comentarios..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="compromisos">Compromisos y Siguientes Pasos</label>
                    <textarea id="compromisos" name="compromisos" placeholder="¬øQu√© se acord√≥? ¬øCu√°les son los pr√≥ximos pasos?"></textarea>
                </div>
                
                <div class="form-group">
                    <label>¬øHubo comentarios, quejas o √°reas de mejora?</label>
                    <div class="checkbox-individual">
                        <input type="checkbox" id="huboQuejas">
                        <label for="huboQuejas">S√≠, hubo comentarios o √°reas de mejora</label>
                    </div>

                    <div id="detalleQuejas" class="campo-condicional" style="display:none;">
                        <div style="margin-bottom: 15px;">
                            <label for="categoriaQueja">Categor√≠a:</label>
                            <select id="categoriaQueja">
                                <option value="">Selecciona una categor√≠a</option>
                                <option value="servicio">Servicio</option>
                                <option value="precio">Precio</option>
                                <option value="contenido">Contenido</option>
                                <option value="metodolog√≠a">Metodolog√≠a</option>
                                <option value="impresi√≥n">Impresi√≥n</option>
                                <option value="digital">Digital</option>
                            </select>
                        </div>
                        <div>
                            <label for="detalleQuejaTexto">Detalle:</label>
                            <textarea id="detalleQuejaTexto" rows="3" placeholder="Describe el comentario o √°rea de mejora..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <button type="button" class="btn-primary" onclick="generarReporte()">
                        üìÑ Generar Reporte
                    </button>
                    <button type="button" class="btn-secondary" onclick="guardarReporte()">
                        üíæ Guardar Borrador
                    </button>
                    <button type="button" class="btn-secondary" onclick="nuevoReporte()">
                        üÜï Nuevo reporte
                    </button>
                </div>
            </form>
            
            <div id="reportePreview" class="reporte-preview">
                <h3>Vista Previa del Reporte</h3>
                <div id="reporteContent" class="reporte-content"></div>
                <div style="margin-top: 20px;">
                    <button class="btn-small btn-primary" onclick="copiarReporte()">üìã Copiar</button>
                    <button class="btn-small btn-secondary" onclick="enviarEmail()">üìß Enviar por Email</button>
                    <button class="btn-small btn-success" onclick="descargarPDF()">üìÑ Descargar PDF</button>
                </div>
            </div>
            
            <div id="savedReports" class="saved-reports" style="display: none;">
                <div class="reports-header">
                    <h3>üìÅ Borradores Guardados</h3>
                    <div class="reports-actions">
                        <button id="btnSincronizar" class="btn-small btn-success" onclick="sincronizarReportesManual()">
                            ‚òÅÔ∏è Sincronizar
                        </button>
                        <button class="btn-small btn-info" onclick="exportarTodosBorradores()">
                            üì¶ Exportar Todos
                        </button>
                        <button class="btn-small btn-info" onclick="generarEstadisticas()">
                            üìä Estad√≠sticas
                        </button>
                        <button class="btn-small btn-danger" onclick="eliminarTodosBorradores()">
                            üóëÔ∏è Eliminar Todos
                        </button>
                    </div>
                </div>
                
                <div id="syncStatus" class="sync-status-bar" style="display: none;">
                    <div class="sync-status-content">
                        <span id="syncStatusText">Estado de sincronizaci√≥n</span>
                        <span id="syncStatusBadge" class="sync-badge"></span>
                    </div>
                </div>
                
                <div class="search-filters">
                    <h4>üîç Buscar y Filtrar Reportes</h4>
                    <div class="search-row">
                        <div>
                            <label for="searchInput" style="font-size: 14px; margin-bottom: 5px;">Buscar por colegio, contacto o zona:</label>
                            <input type="text" id="searchInput" class="search-input" 
                                   placeholder="Escribe para buscar..." 
                                   oninput="filtrarBorradores()">
                        </div>
                        <div>
                            <label for="gerenciaFilter" style="font-size: 14px; margin-bottom: 5px;">Filtrar por gerencia:</label>
                            <select id="gerenciaFilter" class="filter-select" onchange="filtrarBorradores()">
                                <option value="">Todas las gerencias</option>
                                <option value="Baj√≠o">Baj√≠o</option>
                                <option value="Centro-Norte">Centro-Norte</option>
                                <option value="Centro-Sur">Centro-Sur</option>
                                <option value="Norte">Norte</option>
                                <option value="Occidente">Occidente</option>
                                <option value="Oriente">Oriente</option>
                                <option value="Pac√≠fico">Pac√≠fico</option>
                                <option value="Sur">Sur</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="reportsList"></div>
                <div id="noResults" class="no-results" style="display: none;">
                    üîç No se encontraron reportes que coincidan con tu b√∫squeda
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================== CLASE PARA MANEJO DE INDEXEDDB ======================
        class ReportesDB {
            constructor() {
                this.dbName = 'ReportesVisitaDB';
                this.version = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => {
                        console.error('Error al abrir IndexedDB:', request.error);
                        reject(request.error);
                    };
                    
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('IndexedDB inicializada correctamente');
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Crear object store para reportes si no existe
                        if (!db.objectStoreNames.contains('reportes')) {
                            const reportesStore = db.createObjectStore('reportes', { 
                                keyPath: 'id', 
                                autoIncrement: false 
                            });
                            
                            // Crear √≠ndices para b√∫squedas eficientes
                            reportesStore.createIndex('colegio', 'colegio', { unique: false });
                            reportesStore.createIndex('gerencia', 'gerencia', { unique: false });
                            reportesStore.createIndex('zona', 'zona', { unique: false });
                            reportesStore.createIndex('fecha', 'fecha', { unique: false });
                            reportesStore.createIndex('fechaGuardado', 'fechaGuardado', { unique: false });
                            reportesStore.createIndex('nombreContacto', 'nombreContacto', { unique: false });
                            
                            console.log('Object store "reportes" creado con √≠ndices');
                        }
                    };
                });
            }

            async guardarReporte(reporte) {
                if (!this.db) throw new Error('Base de datos no inicializada');
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reportes'], 'readwrite');
                    const store = transaction.objectStore('reportes');
                    
                    // Asegurar que el reporte tenga un ID √∫nico
                    if (!reporte.id) {
                        reporte.id = Date.now() + Math.random().toString(36).substr(2, 9);
                    }
                    
                    const request = store.add(reporte);
                    
                    request.onsuccess = () => {
                        console.log('Reporte guardado:', reporte.id);
                        resolve(reporte.id);
                    };
                    
                    request.onerror = () => {
                        console.error('Error al guardar reporte:', request.error);
                        reject(request.error);
                    };
                });
            }

            async obtenerTodosLosReportes() {
                if (!this.db) throw new Error('Base de datos no inicializada');
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reportes'], 'readonly');
                    const store = transaction.objectStore('reportes');
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    
                    request.onerror = () => {
                        console.error('Error al obtener reportes:', request.error);
                        reject(request.error);
                    };
                });
            }

            async obtenerReportePorId(id) {
                if (!this.db) throw new Error('Base de datos no inicializada');
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reportes'], 'readonly');
                    const store = transaction.objectStore('reportes');
                    const request = store.get(id);
                    
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    
                    request.onerror = () => {
                        console.error('Error al obtener reporte:', request.error);
                        reject(request.error);
                    };
                });
            }

            async eliminarReporte(id) {
                if (!this.db) throw new Error('Base de datos no inicializada');
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reportes'], 'readwrite');
                    const store = transaction.objectStore('reportes');
                    const request = store.delete(id);
                    
                    request.onsuccess = () => {
                        console.log('Reporte eliminado:', id);
                        resolve();
                    };
                    
                    request.onerror = () => {
                        console.error('Error al eliminar reporte:', request.error);
                        reject(request.error);
                    };
                });
            }

            async eliminarTodosLosReportes() {
                if (!this.db) throw new Error('Base de datos no inicializada');
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reportes'], 'readwrite');
                    const store = transaction.objectStore('reportes');
                    const request = store.clear();
                    
                    request.onsuccess = () => {
                        console.log('Todos los reportes eliminados');
                        resolve();
                    };
                    
                    request.onerror = () => {
                        console.error('Error al eliminar todos los reportes:', request.error);
                        reject(request.error);
                    };
                });
            }

            async buscarReportes(termino, gerencia = null) {
                if (!this.db) throw new Error('Base de datos no inicializada');
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reportes'], 'readonly');
                    const store = transaction.objectStore('reportes');
                    
                    let resultados = [];
                    const request = store.openCursor();
                    
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            const reporte = cursor.value;
                            let coincide = true;
                            
                            // Filtro por t√©rmino de b√∫squeda
                            if (termino) {
                                const textoCompleto = `${reporte.colegio} ${reporte.nombreContacto} ${reporte.zona}`.toLowerCase();
                                coincide = coincide && textoCompleto.includes(termino.toLowerCase());
                            }
                            
                            // Filtro por gerencia
                            if (gerencia) {
                                coincide = coincide && reporte.gerencia === gerencia;
                            }
                            
                            if (coincide) {
                                resultados.push(reporte);
                            }
                            
                            cursor.continue();
                        } else {
                            resolve(resultados);
                        }
                    };
                    
                    request.onerror = () => {
                        console.error('Error en b√∫squeda:', request.error);
                        reject(request.error);
                    };
                });
            }

            async obtenerColegiosUnicos() {
                if (!this.db) throw new Error('Base de datos no inicializada');
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reportes'], 'readonly');
                    const store = transaction.objectStore('reportes');
                    const index = store.index('colegio');
                    
                    const colegios = new Set();
                    const request = index.openCursor();
                    
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (cursor.value.colegio && cursor.value.colegio.trim()) {
                                colegios.add(cursor.value.colegio.trim());
                            }
                            cursor.continue();
                        } else {
                            resolve(Array.from(colegios));
                        }
                    };
                    
                    request.onerror = () => {
                        console.error('Error al obtener colegios:', request.error);
                        reject(request.error);
                    };
                });
            }

            async verificarDuplicado(colegio, fecha) {
                if (!this.db) throw new Error('Base de datos no inicializada');
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['reportes'], 'readonly');
                    const store = transaction.objectStore('reportes');
                    const request = store.openCursor();
                    
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            const reporte = cursor.value;
                            if (reporte.colegio.trim().toLowerCase() === colegio.trim().toLowerCase() && 
                                reporte.fecha === fecha) {
                                resolve(true); // Duplicado encontrado
                                return;
                            }
                            cursor.continue();
                        } else {
                            resolve(false); // No hay duplicado
                        }
                    };
                    
                    request.onerror = () => {
                        console.error('Error al verificar duplicado:', request.error);
                        reject(request.error);
                    };
                });
            }
        }

        // ====================== VARIABLES GLOBALES ======================
        const reportesDB = new ReportesDB();
        let reporteActual = null;
        let borradoresOriginales = [];
        let borradoresFiltrados = [];

        // Zonas por gerencia - Estructura organizacional completa
        const zonasPorGerencia = {
            'Baj√≠o': [
                'Celaya', 'Irapuato', 'Le√≥n I', 'Le√≥n II', 'Morelia I', 'Morelia II', 
                'Quer√©taro I', 'Quer√©taro II', 'San Luis Potos√≠ I', 'San Luis Potos√≠ II'
            ],
            'Centro-Norte': [
                'Atizap√°n', 'Cuautitl√°n', 'Ecatepec', 'Gustavo A. Madero', 'Naucalpan', 
                'Neza', 'Tlalnepantla', 'Toluca', 'Tultitl√°n', 'Xochimilco'
            ],
            'Centro-Sur': [
                'Acapulco', '√Ålvaro Obreg√≥n', 'Azcapotzalco', 'Coyoac√°n', 'Cuautla', 
                'Cuernavaca', 'Iztapalapa I', 'Iztapalapa II', 'Miguel Hidalgo', 'Tlalpan'
            ],
            'Norte': [
                'Chihuahua', 'Cd. Ju√°rez', 'Durango', 'Monterrey I', 'Monterrey II', 
                'Monterrey III', 'Monterrey IV', 'Reynosa', 'Saltillo', 'Tampico', 'Torre√≥n'
            ],
            'Occidente': [
                'Aguascalientes', 'Colima', 'Guadalajara I', 'Guadalajara II', 'Tepic', 
                'Tlajomulco', 'Tlaquepaque', 'Zapopan I', 'Zapopan II'
            ],
            'Oriente': [
                'Chalco', 'Oaxaca I', 'Oaxaca II', 'Pachuca', 'Puebla I', 'Puebla II', 
                'Puebla III', 'Texcoco', 'Tulancingo'
            ],
            'Pac√≠fico': [
                'Cd. Obreg√≥n', 'Culiac√°n', 'Hermosillo I', 'Hermosillo II', 'Los Cabos', 
                'Mazatl√°n', 'Mexicali', 'Tijuana I', 'Tijuana II'
            ],
            'Sur': [
                'Canc√∫n', 'C√≥rdoba', 'M√©rida I', 'M√©rida II', 'Playa del Carmen', 'Poza Rica', 
                'Tapachula', 'Tuxtla', 'Veracruz I', 'Veracruz II', 'Villahermosa I', 'Villahermosa II'
            ]
        };

        // ====================== FUNCIONES DE INICIALIZACI√ìN ======================
        window.onload = async function() {
            try {
                mostrarMensaje('‚è≥ Inicializando sistema...', 'warning');
                await reportesDB.init();
                await cargarBorradores();
                await cargarAutocompletadoColegios();
                document.getElementById('fecha').valueAsDate = new Date();
                document.getElementById('colegio').focus();
                mostrarMensaje('‚úÖ Sistema iniciado correctamente', 'success');
            } catch (error) {
                console.error('Error al inicializar:', error);
                mostrarMensaje('‚ùå Error al inicializar el sistema. Recarga la p√°gina.', 'error');
            }
        };

        // ====================== FUNCIONES DE INTERFAZ ======================
        function actualizarZonas() {
            const gerenciaSelect = document.getElementById('gerencia');
            const zonaSelect = document.getElementById('zona');
            const gerenciaSeleccionada = gerenciaSelect.value;
            
            zonaSelect.innerHTML = '';
            
            if (gerenciaSeleccionada) {
                zonaSelect.innerHTML = '<option value="">Seleccionar zona</option>';
                const zonas = zonasPorGerencia[gerenciaSeleccionada] || [];
                zonas.forEach(zona => {
                    const option = document.createElement('option');
                    option.value = zona;
                    option.textContent = zona;
                    zonaSelect.appendChild(option);
                });
            } else {
                zonaSelect.innerHTML = '<option value="">Primero selecciona una gerencia</option>';
            }
        }

        function mostrarCampoOtroObjetivo() {
            const objetivoSelect = document.getElementById('objetivo');
            const otroContainer = document.getElementById('otroObjetivoContainer');
            const otroInput = document.getElementById('otroObjetivo');
            
            if (objetivoSelect.value === 'Otro') {
                otroContainer.style.display = 'block';
                otroInput.required = true;
            } else {
                otroContainer.style.display = 'none';
                otroInput.required = false;
                otroInput.value = '';
            }
        }

        function formatearTelefono(input) {
            let valor = input.value.replace(/\D/g, '');
            
            if (valor.length === 10) {
                input.value = valor.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            } else if (valor.length === 0) {
                input.value = '';
            }
        }

        function validarTelefono(telefono) {
            const soloNumeros = telefono.replace(/\D/g, '');
            return soloNumeros.length === 10;
        }

        function mostrarMensaje(texto, tipo = 'success') {
            const messagesDiv = document.getElementById('messages');
            const mensaje = document.createElement('div');
            mensaje.className = `message ${tipo}`;
            mensaje.textContent = texto;
            mensaje.style.display = 'block';
            
            messagesDiv.innerHTML = '';
            messagesDiv.appendChild(mensaje);
            
            setTimeout(() => {
                mensaje.style.display = 'none';
            }, 3000);
        }

        function limpiarVistaPrevia() {
            document.getElementById('reportePreview').style.display = 'none';
            document.getElementById('reporteContent').innerHTML = '';
            reporteActual = null;
        }

        // ====================== FUNCIONES DE AUTOCOMPLETADO ======================
        async function cargarAutocompletadoColegios() {
            try {
                const colegiosUnicos = await reportesDB.obtenerColegiosUnicos();
                const datalist = document.getElementById('colegiosDatalist');
                datalist.innerHTML = '';
                
                colegiosUnicos.forEach(colegio => {
                    const option = document.createElement('option');
                    option.value = colegio;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar autocompletado:', error);
            }
        }

        // ====================== FUNCIONES PRINCIPALES ======================
        async function generarReporte() {
            const form = document.getElementById('visitaForm');
            const formData = new FormData(form);
            
            if (!form.checkValidity()) {
                form.reportValidity();
                mostrarMensaje('‚ö†Ô∏è Por favor completa todos los campos requeridos', 'warning');
                return;
            }

            const telefono = formData.get('telefonoContacto');
            if (!validarTelefono(telefono)) {
                mostrarMensaje('‚ö†Ô∏è El tel√©fono debe tener exactamente 10 d√≠gitos', 'warning');
                document.getElementById('telefonoContacto').focus();
                return;
            }
            
            const fecha = formData.get('fecha');
            const fechaFormateada = new Date(fecha).toLocaleDateString('es-MX', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let objetivoFinal = formData.get('objetivo');
            if (objetivoFinal === 'Otro') {
                objetivoFinal = formData.get('otroObjetivo') || 'Otro';
            }
            
            reporteActual = {
                colegio: formData.get('colegio'),
                esUsuario: formData.get('esUsuario'),
                detalleUsuario: document.getElementById('detalleUsuarioInput').value,
                detalleCompetencia: document.getElementById('detalleCompetenciaInput').value,
                gerencia: formData.get('gerencia'),
                zona: formData.get('zona'),
                fecha: fecha,
                fechaFormateada: fechaFormateada,
                objetivo: objetivoFinal,
                nombreContacto: formData.get('nombreContacto'),
                cargoContacto: formData.get('cargoContacto'),
                telefonoContacto: formData.get('telefonoContacto'),
                correoContacto: formData.get('correoContacto'),
                productos: formData.get('productos'),
                notas: formData.get('notas'),
                compromisos: formData.get('compromisos'),
                huboQuejas: document.getElementById('huboQuejas').checked,
                categoriaQueja: document.getElementById('categoriaQueja').value,
                detalleQuejaTexto: document.getElementById('detalleQuejaTexto').value
            };
            
            const reporte = `
<h2 style="margin-bottom: 10px;">üìã Reporte de Visita</h2>
<p><strong>Editorial:</strong> University of Dayton Publishing</p>

<hr style="margin: 20px 0;">

<h3>Informaci√≥n General</h3>
<p><strong>Instituci√≥n:</strong> ${reporteActual.colegio}</p>
<p><strong>¬øEs usuario?:</strong> ${reporteActual.esUsuario || 'No especificado'}</p>
${reporteActual.esUsuario === 'S√≠' && reporteActual.detalleUsuario ? 
  `<p><strong>Producto/l√≠nea que utiliza:</strong> ${reporteActual.detalleUsuario}</p>` : ''}
${reporteActual.esUsuario === 'No' && reporteActual.detalleCompetencia ? 
  `<p><strong>Competencia que utiliza:</strong> ${reporteActual.detalleCompetencia}</p>` : ''}
<p><strong>Gerencia:</strong> ${reporteActual.gerencia}</p>
<p><strong>Zona Comercial:</strong> ${reporteActual.zona}</p>
<p><strong>Fecha de Visita:</strong> ${reporteActual.fechaFormateada}</p>
<p><strong>Objetivo:</strong> ${reporteActual.objetivo}</p>

<hr style="margin: 20px 0;">

<h3>Contacto</h3>
<p><strong>Nombre:</strong> ${reporteActual.nombreContacto}</p>
<p><strong>Cargo:</strong> ${reporteActual.cargoContacto}</p>
<p><strong>Tel√©fono:</strong> ${reporteActual.telefonoContacto}</p>
<p><strong>Correo:</strong> ${reporteActual.correoContacto}</p>

<hr style="margin: 20px 0;">

<h3>Productos/Servicios Presentados</h3>
<p>${reporteActual.productos.replace(/\n/g, '<br>')}</p>

<h3>Notas Relevantes</h3>
<p>${reporteActual.notas.replace(/\n/g, '<br>')}</p>

<h3>Compromisos y Siguientes Pasos</h3>
<p>${reporteActual.compromisos.replace(/\n/g, '<br>')}</p>

${reporteActual.huboQuejas ? `
<hr style="margin: 20px 0;">
<h3>Comentarios y √Åreas de Mejora</h3>
<p><strong>Categor√≠a:</strong> ${reporteActual.categoriaQueja || 'No especificada'}</p>
<p><strong>Detalle:</strong> ${reporteActual.detalleQuejaTexto.replace(/\n/g, '<br>') || 'No especificado'}</p>
` : ''}

<hr style="margin: 20px 0;">
<p><em>Reporte generado el ${new Date().toLocaleDateString('es-MX')} a las ${new Date().toLocaleTimeString('es-MX')}</em></p>
            `;
            
            document.getElementById('reporteContent').innerHTML = reporte;
            document.getElementById('reportePreview').style.display = 'block';
            document.getElementById('reportePreview').scrollIntoView({ behavior: 'smooth' });
            
            mostrarMensaje('‚úÖ Reporte generado exitosamente');
        }

        async function guardarReporte() {
            const form = document.getElementById('visitaForm');
            const formData = new FormData(form);

            if (!formData.get('colegio') || formData.get('colegio').trim() === '') {
                mostrarMensaje('‚ö†Ô∏è Ingresa al menos el nombre del colegio para guardar', 'warning');
                return;
            }

            const telefono = formData.get('telefonoContacto');
            if (telefono && telefono.trim() && !validarTelefono(telefono)) {
                mostrarMensaje('‚ö†Ô∏è El tel√©fono debe tener exactamente 10 d√≠gitos', 'warning');
                document.getElementById('telefonoContacto').focus();
                return;
            }
        
            const colegio = formData.get('colegio').trim();
            const fecha = formData.get('fecha');

            try {
                const duplicado = await reportesDB.verificarDuplicado(colegio, fecha);
                if (duplicado) {
                    mostrarMensaje('‚ö†Ô∏è Ya existe un borrador con esta instituci√≥n y fecha', 'warning');
                    return;
                }

                let objetivoFinal = formData.get('objetivo');
                if (objetivoFinal === 'Otro') {
                    objetivoFinal = formData.get('otroObjetivo') || 'Otro';
                }
                
                const reporte = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    colegio: formData.get('colegio'),
                    esUsuario: formData.get('esUsuario'),
                    detalleUsuario: document.getElementById('detalleUsuarioInput').value,
                    detalleCompetencia: document.getElementById('detalleCompetenciaInput').value,
                    gerencia: formData.get('gerencia'),
                    zona: formData.get('zona'),
                    fecha: formData.get('fecha'),
                    objetivo: objetivoFinal,
                    otroObjetivo: formData.get('otroObjetivo'),
                    nombreContacto: formData.get('nombreContacto'),
                    cargoContacto: formData.get('cargoContacto'),
                    telefonoContacto: formData.get('telefonoContacto'),
                    correoContacto: formData.get('correoContacto'),
                    productos: formData.get('productos'),
                    notas: formData.get('notas'),
                    compromisos: formData.get('compromisos'),
                    huboQuejas: document.getElementById('huboQuejas').checked,
                    categoriaQueja: document.getElementById('categoriaQueja').value,
                    detalleQuejaTexto: document.getElementById('detalleQuejaTexto').value,
                    fechaGuardado: new Date().toISOString()
                };
                
                await reportesDB.guardarReporte(reporte);

                mostrarMensaje('üíæ Borrador guardado exitosamente');
                await cargarBorradores();
                await cargarAutocompletadoColegios();
                
            } catch (error) {
                console.error('Error al guardar reporte:', error);
                mostrarMensaje('‚ùå Error al guardar el reporte. Intenta nuevamente.', 'error');
            }
        }

        // ====================== FUNCIONES DE BORRADORES ======================
        async function cargarBorradores() {
            try {
                const borradores = await reportesDB.obtenerTodosLosReportes();
                borradoresOriginales = [...borradores];
                const savedReports = document.getElementById('savedReports');
                
                if (borradores.length === 0) {
                    savedReports.style.display = 'none';
                    return;
                }
                
                savedReports.style.display = 'block';
                mostrarBorradoresFiltrados(borradores);
            } catch (error) {
                console.error('Error al cargar borradores:', error);
                mostrarMensaje('‚ùå Error al cargar los borradores guardados', 'error');
            }
        }

        async function cargarBorrador(id) {
            try {
                const borrador = await reportesDB.obtenerReportePorId(id);
                
                if (borrador) {
                    document.getElementById('colegio').value = borrador.colegio;
                    document.getElementById('gerencia').value = borrador.gerencia;
                    actualizarZonas();
                    setTimeout(() => {
                        document.getElementById('zona').value = borrador.zona;
                    }, 100);
                    document.getElementById('fecha').value = borrador.fecha;
                    
                    if (borrador.otroObjetivo) {
                        document.getElementById('objetivo').value = 'Otro';
                        mostrarCampoOtroObjetivo();
                        document.getElementById('otroObjetivo').value = borrador.otroObjetivo;
                    } else {
                        document.getElementById('objetivo').value = borrador.objetivo;
                        mostrarCampoOtroObjetivo();
                    }
                    
                    if (borrador.esUsuario) {
                        if (borrador.esUsuario === 'S√≠') {
                            document.getElementById('usuario_si').checked = true;
                            document.getElementById('detalleUsuario').style.display = 'block';
                            document.getElementById('detalleUsuarioInput').value = borrador.detalleUsuario || '';
                            document.getElementById('detalleCompetencia').style.display = 'none';
                        } else if (borrador.esUsuario === 'No') {
                            document.getElementById('usuario_no').checked = true;
                            document.getElementById('detalleCompetencia').style.display = 'block';
                            document.getElementById('detalleCompetenciaInput').value = borrador.detalleCompetencia || '';
                            document.getElementById('detalleUsuario').style.display = 'none';
                        }
                    }

                    document.getElementById('nombreContacto').value = borrador.nombreContacto || '';
                    document.getElementById('cargoContacto').value = borrador.cargoContacto || '';
                    document.getElementById('telefonoContacto').value = borrador.telefonoContacto || '';
                    document.getElementById('correoContacto').value = borrador.correoContacto || '';
                    document.getElementById('productos').value = borrador.productos || '';
                    document.getElementById('notas').value = borrador.notas || '';
                    document.getElementById('compromisos').value = borrador.compromisos || '';

                    if (borrador.huboQuejas) {
                        document.getElementById('huboQuejas').checked = true;
                        document.getElementById('detalleQuejas').style.display = 'block';
                        document.getElementById('categoriaQueja').value = borrador.categoriaQueja || '';
                        document.getElementById('detalleQuejaTexto').value = borrador.detalleQuejaTexto || '';
                    } else {
                        document.getElementById('huboQuejas').checked = false;
                        document.getElementById('detalleQuejas').style.display = 'none';
                    }
                    
                    document.getElementById('searchInput').value = '';
                    document.getElementById('gerenciaFilter').value = '';
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    mostrarMensaje('üìù Borrador cargado para edici√≥n');
                }
            } catch (error) {
                console.error('Error al cargar borrador:', error);
                mostrarMensaje('‚ùå Error al cargar el borrador', 'error');
            }
        }

        async function eliminarBorrador(id) {
            if (confirm('¬øEst√°s seguro de eliminar este borrador?')) {
                try {
                    await reportesDB.eliminarReporte(id);
                    await cargarBorradores();
                    await cargarAutocompletadoColegios();
                    mostrarMensaje('üóëÔ∏è Borrador eliminado exitosamente');
                } catch (error) {
                    console.error('Error al eliminar borrador:', error);
                    mostrarMensaje('‚ùå Error al eliminar el borrador', 'error');
                }
            }
        }

        async function eliminarTodosBorradores() {
            try {
                const borradores = await reportesDB.obtenerTodosLosReportes();
                if (borradores.length === 0) {
                    mostrarMensaje('‚ö†Ô∏è No hay borradores para eliminar', 'warning');
                    return;
                }
                
                if (confirm(`¬øEst√°s seguro de eliminar TODOS los borradores guardados? (${borradores.length} borradores)\n\nEsta acci√≥n no se puede deshacer.`)) {
                    await reportesDB.eliminarTodosLosReportes();
                    await cargarBorradores();
                    await cargarAutocompletadoColegios();
                    document.getElementById('searchInput').value = '';
                    document.getElementById('gerenciaFilter').value = '';
                    mostrarMensaje('üóëÔ∏è Todos los borradores han sido eliminados');
                }
            } catch (error) {
                console.error('Error al eliminar todos los borradores:', error);
                mostrarMensaje('‚ùå Error al eliminar los borradores', 'error');
            }
        }

        // ====================== FUNCIONES DE B√öSQUEDA Y FILTRADO ======================
        async function filtrarBorradores() {
            const terminoBusqueda = document.getElementById('searchInput').value.toLowerCase().trim();
            const gerenciaFiltro = document.getElementById('gerenciaFilter').value;
            
            try {
                if (!terminoBusqueda && !gerenciaFiltro) {
                    mostrarBorradoresFiltrados(borradoresOriginales);
                    return;
                }
                
                const borradoresFiltrados = await reportesDB.buscarReportes(terminoBusqueda, gerenciaFiltro);
                mostrarBorradoresFiltrados(borradoresFiltrados);
            } catch (error) {
                console.error('Error al filtrar borradores:', error);
                mostrarMensaje('‚ùå Error al filtrar los reportes', 'error');
            }
        }
        
        function mostrarBorradoresFiltrados(borradores) {
            const reportsList = document.getElementById('reportsList');
            const noResults = document.getElementById('noResults');
            
            if (borradores.length === 0) {
                reportsList.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }
            
            reportsList.style.display = 'block';
            noResults.style.display = 'none';
            reportsList.innerHTML = '';
            
            // Ordenar por fecha de guardado (m√°s recientes primero)
            const borradoresOrdenados = [...borradores].sort((a, b) => 
                new Date(b.fechaGuardado) - new Date(a.fechaGuardado)
            );
            
            borradoresOrdenados.forEach(borrador => {
                const fecha = new Date(borrador.fecha).toLocaleDateString('es-MX');
                const fechaGuardado = new Date(borrador.fechaGuardado).toLocaleDateString('es-MX');
                
                const item = document.createElement('div');
                item.className = 'report-item';
                item.innerHTML = `
                    <strong>${borrador.colegio}</strong> - ${borrador.gerencia} - ${borrador.zona}<br>
                    <small>Contacto: ${borrador.nombreContacto} | Visita: ${fecha} | Guardado: ${fechaGuardado}</small>
                    <div class="report-actions">
                        <button class="btn-small btn-primary" onclick="cargarBorrador('${borrador.id}')">üìù Editar</button>
                        <button class="btn-small btn-danger" onclick="eliminarBorrador('${borrador.id}')">üóëÔ∏è Eliminar</button>
                    </div>
                `;
                reportsList.appendChild(item);
            });
        }

        // ====================== FUNCIONES DE EXPORTACI√ìN Y ESTAD√çSTICAS ======================
        async function exportarTodosBorradores() {
            try {
                const borradores = await reportesDB.obtenerTodosLosReportes();
                
                if (borradores.length === 0) {
                    mostrarMensaje('‚ö†Ô∏è No hay borradores guardados para exportar', 'warning');
                    return;
                }
                
                const fechaExportacion = new Date().toLocaleString('es-MX');
                const totalReportes = borradores.length;
                
                const gerencias = {};
                borradores.forEach(b => {
                    gerencias[b.gerencia] = (gerencias[b.gerencia] || 0) + 1;
                });
                
                let contenidoCompleto = `EXPORTACI√ìN COMPLETA DE REPORTES DE VISITA
University of Dayton Publishing

ESTAD√çSTICAS B√ÅSICAS
===================
‚Ä¢ Total de reportes: ${totalReportes}
‚Ä¢ Fecha de exportaci√≥n: ${fechaExportacion}

DISTRIBUCI√ìN POR GERENCIA:
`;
                
                Object.entries(gerencias).forEach(([gerencia, cantidad]) => {
                    contenidoCompleto += `‚Ä¢ ${gerencia}: ${cantidad} reportes\n`;
                });
                
                contenidoCompleto += `
${'='.repeat(60)}

REPORTES COMPLETOS
==================

`;
                
                borradores.forEach((reporte, index) => {
                    const fechaFormateada = new Date(reporte.fecha).toLocaleDateString('es-MX', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    const fechaGuardado = new Date(reporte.fechaGuardado).toLocaleString('es-MX');
                    
                    contenidoCompleto += `REPORTE #${index + 1}
${'-'.repeat(20)}

INFORMACI√ìN GENERAL
Instituci√≥n: ${reporte.colegio}
¬øEs usuario?: ${reporte.esUsuario || 'No especificado'}
${reporte.esUsuario === 'S√≠' && reporte.detalleUsuario ? 
  `Producto/l√≠nea que utiliza: ${reporte.detalleUsuario}\n` : ''}
${reporte.esUsuario === 'No' && reporte.detalleCompetencia ? 
  `Competencia que utiliza: ${reporte.detalleCompetencia}\n` : ''}
Gerencia: ${reporte.gerencia}
Zona Comercial: ${reporte.zona}
Fecha de Visita: ${fechaFormateada}
Objetivo: ${reporte.objetivo}

CONTACTO
Nombre: ${reporte.nombreContacto}
Cargo: ${reporte.cargoContacto}
Tel√©fono: ${reporte.telefonoContacto}
Correo: ${reporte.correoContacto}

PRODUCTOS/SERVICIOS PRESENTADOS
${reporte.productos}

NOTAS RELEVANTES
${reporte.notas}

COMPROMISOS Y SIGUIENTES PASOS
${reporte.compromisos}

${reporte.huboQuejas ? `COMENTARIOS Y √ÅREAS DE MEJORA
Categor√≠a: ${reporte.categoriaQueja || 'No especificada'}
Detalle: ${reporte.detalleQuejaTexto || 'No especificado'}

` : ''}Guardado: ${fechaGuardado}

${'='.repeat(60)}

`;
                });
                
                const nombreArchivo = `exportacion_completa_reportes_${new Date().toISOString().split('T')[0]}.txt`;
                descargarArchivo(nombreArchivo, contenidoCompleto);
                
                mostrarMensaje(`üì¶ Exportaci√≥n completa descargada: ${totalReportes} reportes`);
                
            } catch (error) {
                console.error('Error al exportar borradores:', error);
                mostrarMensaje('‚ùå Error al exportar los reportes', 'error');
            }
        }
        
        async function generarEstadisticas() {
            try {
                const borradores = await reportesDB.obtenerTodosLosReportes();
                
                if (borradores.length === 0) {
                    mostrarMensaje('‚ö†Ô∏è No hay reportes guardados para generar estad√≠sticas', 'warning');
                    return;
                }
                
                const fechaGeneracion = new Date().toLocaleString('es-MX');
                const totalVisitas = borradores.length;
                
                const visitasPorGerencia = {};
                borradores.forEach(b => {
                    visitasPorGerencia[b.gerencia] = (visitasPorGerencia[b.gerencia] || 0) + 1;
                });
                
                const visitasPorColegio = {};
                borradores.forEach(b => {
                    visitasPorColegio[b.colegio] = (visitasPorColegio[b.colegio] || 0) + 1;
                });
                
                const colegiosMasVisitados = Object.entries(visitasPorColegio)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);
                
                const fechas = borradores.map(b => new Date(b.fecha)).sort();
                const fechaInicio = fechas[0].toLocaleDateString('es-MX');
                const fechaFin = fechas[fechas.length - 1].toLocaleDateString('es-MX');
                
                const objetivos = {};
                borradores.forEach(b => {
                    objetivos[b.objetivo] = (objetivos[b.objetivo] || 0) + 1;
                });
                
                const objetivosMasComunes = Object.entries(objetivos)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                const zonas = {};
                borradores.forEach(b => {
                    zonas[b.zona] = (zonas[b.zona] || 0) + 1;
                });
                
                const zonasMasActivas = Object.entries(zonas)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);
                
                let contenidoEstadisticas = `ESTAD√çSTICAS DE ACTIVIDAD - REPORTES DE VISITA
University of Dayton Publishing

RESUMEN EJECUTIVO
=================
‚Ä¢ Total de visitas registradas: ${totalVisitas}
‚Ä¢ Per√≠odo de actividad: ${fechaInicio} - ${fechaFin}
‚Ä¢ Reporte generado: ${fechaGeneracion}

DISTRIBUCI√ìN POR GERENCIA
=========================
`;
                
                Object.entries(visitasPorGerencia)
                    .sort(([,a], [,b]) => b - a)
                    .forEach(([gerencia, cantidad]) => {
                        const porcentaje = ((cantidad / totalVisitas) * 100).toFixed(1);
                        contenidoEstadisticas += `‚Ä¢ ${gerencia}: ${cantidad} visitas (${porcentaje}%)\n`;
                    });
                
                contenidoEstadisticas += `
COLEGIOS M√ÅS VISITADOS (TOP 10)
===============================
`;
                
                colegiosMasVisitados.forEach(([colegio, cantidad], index) => {
                    contenidoEstadisticas += `${index + 1}. ${colegio}: ${cantidad} visita${cantidad > 1 ? 's' : ''}\n`;
                });
                
                contenidoEstadisticas += `
OBJETIVOS M√ÅS COMUNES (TOP 5)
=============================
`;
                
                objetivosMasComunes.forEach(([objetivo, cantidad], index) => {
                    const porcentaje = ((cantidad / totalVisitas) * 100).toFixed(1);
                    contenidoEstadisticas += `${index + 1}. ${objetivo}: ${cantidad} veces (${porcentaje}%)\n`;
                });
                
                contenidoEstadisticas += `
ZONAS M√ÅS ACTIVAS (TOP 10)
==========================
`;
                
                zonasMasActivas.forEach(([zona, cantidad], index) => {
                    const porcentaje = ((cantidad / totalVisitas) * 100).toFixed(1);
                    contenidoEstadisticas += `${index + 1}. ${zona}: ${cantidad} visita${cantidad > 1 ? 's' : ''} (${porcentaje}%)\n`;
                });
                
                contenidoEstadisticas += `
AN√ÅLISIS TEMPORAL
=================
‚Ä¢ Primera visita registrada: ${fechaInicio}
‚Ä¢ √öltima visita registrada: ${fechaFin}
‚Ä¢ Promedio de visitas por gerencia: ${(totalVisitas / Object.keys(visitasPorGerencia).length).toFixed(1)}

NOTAS ADICIONALES
=================
- Este reporte se basa en ${totalVisitas} reportes de visita guardados en IndexedDB
- Las estad√≠sticas reflejan la actividad acumulada hasta la fecha de generaci√≥n
- Para an√°lisis m√°s detallados, consulte los reportes individuales

${'='.repeat(60)}
Reporte generado autom√°ticamente por el Sistema de Reportes de Visita
University of Dayton Publishing
`;
                
                const nombreArchivo = `estadisticas_actividad_${new Date().toISOString().split('T')[0]}.txt`;
                descargarArchivo(nombreArchivo, contenidoEstadisticas);
                
                mostrarMensaje(`üìä Estad√≠sticas generadas: ${totalVisitas} reportes analizados`);
                
            } catch (error) {
                console.error('Error al generar estad√≠sticas:', error);
                mostrarMensaje('‚ùå Error al generar estad√≠sticas', 'error');
            }
        }

        // ====================== FUNCIONES DE PDF ======================
        function descargarPDF() {
            if (!reporteActual) {
                mostrarMensaje('‚ö†Ô∏è Primero genera un reporte', 'warning');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const margenIzq = 20;
                const margenDer = 20;
                const anchoUtil = 210 - margenIzq - margenDer;
                let yPos = 20;
                
                function agregarTexto(texto, x, y, opciones = {}) {
                    const lineas = doc.splitTextToSize(texto, anchoUtil);
                    doc.text(lineas, x, y, opciones);
                    return y + (lineas.length * 7);
                }
                
                function verificarEspacio(alturaRequerida) {
                    if (yPos + alturaRequerida > 280) {
                        doc.addPage();
                        yPos = 20;
                    }
                }
                
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                yPos = agregarTexto('REPORTE DE VISITA', margenIzq, yPos);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                yPos = agregarTexto('University of Dayton Publishing', margenIzq, yPos + 5);
                yPos += 15;
                
                doc.line(margenIzq, yPos, 210 - margenDer, yPos);
                yPos += 15;
                
                verificarEspacio(60);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                yPos = agregarTexto('INFORMACI√ìN GENERAL', margenIzq, yPos);
                yPos += 5;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                yPos = agregarTexto(`Instituci√≥n: ${reporteActual.colegio}`, margenIzq, yPos);
                yPos = agregarTexto(`¬øEs usuario?: ${reporteActual.esUsuario || 'No especificado'}`, margenIzq, yPos);
                if (reporteActual.esUsuario === 'S√≠' && reporteActual.detalleUsuario) {
                    yPos = agregarTexto(`Producto/l√≠nea que utiliza: ${reporteActual.detalleUsuario}`, margenIzq, yPos);
                }
                if (reporteActual.esUsuario === 'No' && reporteActual.detalleCompetencia) {
                    yPos = agregarTexto(`Competencia que utiliza: ${reporteActual.detalleCompetencia}`, margenIzq, yPos);
                }
                yPos = agregarTexto(`Gerencia: ${reporteActual.gerencia}`, margenIzq, yPos);
                yPos = agregarTexto(`Zona Comercial: ${reporteActual.zona}`, margenIzq, yPos);
                yPos = agregarTexto(`Fecha de Visita: ${reporteActual.fechaFormateada}`, margenIzq, yPos);
                yPos = agregarTexto(`Objetivo: ${reporteActual.objetivo}`, margenIzq, yPos);
                yPos += 10;
                
                verificarEspacio(40);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                yPos = agregarTexto('CONTACTO', margenIzq, yPos);
                yPos += 5;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                yPos = agregarTexto(`Nombre: ${reporteActual.nombreContacto}`, margenIzq, yPos);
                yPos = agregarTexto(`Cargo: ${reporteActual.cargoContacto}`, margenIzq, yPos);
                yPos = agregarTexto(`Tel√©fono: ${reporteActual.telefonoContacto}`, margenIzq, yPos);
                yPos = agregarTexto(`Correo: ${reporteActual.correoContacto}`, margenIzq, yPos);
                yPos += 10;
                
                verificarEspacio(30);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                yPos = agregarTexto('PRODUCTOS/SERVICIOS PRESENTADOS', margenIzq, yPos);
                yPos += 5;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                if (reporteActual.productos && reporteActual.productos.trim()) {
                    yPos = agregarTexto(reporteActual.productos, margenIzq, yPos);
                } else {
                    yPos = agregarTexto('No especificado', margenIzq, yPos);
                }
                yPos += 10;
                
                verificarEspacio(30);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                yPos = agregarTexto('NOTAS RELEVANTES', margenIzq, yPos);
                yPos += 5;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                if (reporteActual.notas && reporteActual.notas.trim()) {
                    yPos = agregarTexto(reporteActual.notas, margenIzq, yPos);
                } else {
                    yPos = agregarTexto('No especificado', margenIzq, yPos);
                }
                yPos += 10;
                
                verificarEspacio(30);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                yPos = agregarTexto('COMPROMISOS Y SIGUIENTES PASOS', margenIzq, yPos);
                yPos += 5;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                if (reporteActual.compromisos && reporteActual.compromisos.trim()) {
                    yPos = agregarTexto(reporteActual.compromisos, margenIzq, yPos);
                } else {
                    yPos = agregarTexto('No especificado', margenIzq, yPos);
                }
                yPos += 15;
                
                if (reporteActual.huboQuejas) {
                    verificarEspacio(30);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    yPos = agregarTexto('COMENTARIOS Y √ÅREAS DE MEJORA', margenIzq, yPos);
                    yPos += 5;
    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    yPos = agregarTexto(`Categor√≠a: ${reporteActual.categoriaQueja || 'No especificada'}`, margenIzq, yPos);
                    if (reporteActual.detalleQuejaTexto && reporteActual.detalleQuejaTexto.trim()) {
                        yPos = agregarTexto(`Detalle: ${reporteActual.detalleQuejaTexto}`, margenIzq, yPos);
                    }
                    yPos += 10;
                }

                verificarEspacio(20);
                doc.line(margenIzq, yPos, 210 - margenDer, yPos);
                yPos += 10;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'italic');
                const fechaGeneracion = `Reporte generado el ${new Date().toLocaleDateString('es-MX')} a las ${new Date().toLocaleTimeString('es-MX')}`;
                yPos = agregarTexto(fechaGeneracion, margenIzq, yPos);
                
                const nombreArchivo = `reporte_${reporteActual.colegio.replace(/\s+/g, "_")}_${reporteActual.fecha}.pdf`;
                doc.save(nombreArchivo);
                mostrarMensaje('üìÑ PDF descargado exitosamente');
                
            } catch (error) {
                console.error('Error al generar PDF:', error);
                mostrarMensaje('‚ùå Error al generar el PDF. Intenta nuevamente.', 'warning');
            }
        }

        // ====================== FUNCIONES AUXILIARES ======================
        function copiarReporte() {
            const contenido = document.getElementById('reporteContent').innerText;
            navigator.clipboard.writeText(contenido).then(() => {
                mostrarMensaje('‚úÖ Reporte copiado al portapapeles');
            }).catch(() => {
                mostrarMensaje('‚ùå Error al copiar al portapapeles', 'warning');
            });
        }

        function enviarEmail() {
            const contenido = document.getElementById('reporteContent').innerText;
            const asunto = `Reporte de Visita - ${document.getElementById('colegio').value}`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(contenido)}`;
            window.location.href = mailtoLink;
        }
        
        function descargarArchivo(nombre, contenido) {
            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
            const enlace = document.createElement('a');
            enlace.href = URL.createObjectURL(blob);
            enlace.download = nombre;
            document.body.appendChild(enlace);
            enlace.click();
            document.body.removeChild(enlace);
        }

        function nuevoReporte() {
            document.getElementById("visitaForm").reset();
            
            document.getElementById("detalleUsuario").style.display = "none";
            document.getElementById("detalleCompetencia").style.display = "none";
            document.getElementById("detalleQuejas").style.display = "none";
            document.getElementById("otroObjetivoContainer").style.display = "none";
            
            document.getElementById('zona').innerHTML = '<option value="">Primero selecciona una gerencia</option>';
            document.getElementById('fecha').valueAsDate = new Date();
            
            limpiarVistaPrevia();
            document.getElementById('messages').innerHTML = '';
            document.getElementById('colegio').focus();
            
            mostrarMensaje('üìù Formulario reiniciado para nuevo reporte');
        }

        // ====================== EVENT LISTENERS ======================
        document.addEventListener("DOMContentLoaded", function () {
            const usuarioSi = document.getElementById("usuario_si");
            const usuarioNo = document.getElementById("usuario_no");
            const detalleUsuario = document.getElementById("detalleUsuario");
            const detalleCompetencia = document.getElementById("detalleCompetencia");
            const huboQuejas = document.getElementById("huboQuejas");
            const detalleQuejas = document.getElementById("detalleQuejas");

            if (usuarioSi && usuarioNo) {
                usuarioSi.addEventListener("change", () => {
                    if (usuarioSi.checked) {
                        detalleUsuario.style.display = "block";
                        detalleCompetencia.style.display = "none";
                        document.getElementById('detalleCompetenciaInput').value = '';
                    }
                });
                usuarioNo.addEventListener("change", () => {
                    if (usuarioNo.checked) {
                        detalleUsuario.style.display = "none";
                        detalleCompetencia.style.display = "block";
                        document.getElementById('detalleUsuarioInput').value = '';
                    }
                });
            }

            if (huboQuejas) {
                huboQuejas.addEventListener("change", () => {
                    if (huboQuejas.checked) {
                        detalleQuejas.style.display = "block";
                    } else {
                        detalleQuejas.style.display = "none";
                        document.getElementById('categoriaQueja').value = '';
                        document.getElementById('detalleQuejaTexto').value = '';
                    }
                });
            }
        });
        
        // ============== FUNCIONES DE INTEGRACI√ìN CON AUTENTICACI√ìN ==============
        function inicializarAppConUsuario(usuario) {
            console.log('‚úÖ Inicializando app para usuario:', usuario.nombre);
            
            // Mostrar informaci√≥n del usuario
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userName').textContent = `üëã ${usuario.nombre}`;
            
            // Configurar variables globales del usuario
            window.usuarioActual = usuario;
            
            // Si es administrador, mostrar bot√≥n de panel admin
            if (usuario.rol === 'administrador' && interfazLogin) {
                interfazLogin.mostrarPanelAdmin();
            }
            
            // Inicializar sincronizaci√≥n con Firebase autom√°ticamente
            setTimeout(async () => {
                if (!sincronizador) {
                    console.log('üöÄ Inicializando Firebase autom√°ticamente...');
                    sincronizador = new SincronizadorFirebase();
                    sincronizador.usuarioActual = usuario;
                    const inicializado = await sincronizador.inicializar();
                    
                    if (inicializado) {
                        console.log('‚úÖ Firebase listo para sincronizaci√≥n');
                        // Sincronizar autom√°ticamente al inicio
                        if (navigator.onLine) {
                            console.log('üîÑ Sincronizando datos al inicio...');
                            await sincronizador.sincronizarBidireccional();
                            // Asegurar que la UI se actualice despu√©s de la sincronizaci√≥n
                            if (typeof cargarBorradores === 'function') {
                                await cargarBorradores();
                            }
                            await actualizarEstadoSincronizacion();
                        }
                    }
                }
            }, 2000);
        }
        
        function cerrarSesion() {
            if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                if (sistemaAuth) {
                    sistemaAuth.logout();
                }
            }
        }
        
        // Funci√≥n global para mostrar panel de administrador
        window.mostrarPanelAdministrador = mostrarPanelAdministrador;
        
        // ============== FUNCIONES DE SINCRONIZACI√ìN ==============
        async function actualizarEstadoSincronizacion() {
            try {
                const reportesLocales = await reportesDB.obtenerTodosLosReportes();
                const pendientes = reportesLocales.filter(r => !r.sincronizadoFirebase);
                const sincronizados = reportesLocales.filter(r => r.sincronizadoFirebase);
                
                const statusBar = document.getElementById('syncStatus');
                const statusText = document.getElementById('syncStatusText');
                const statusBadge = document.getElementById('syncStatusBadge');
                const btnSync = document.getElementById('btnSincronizar');
                
                if (!statusBar || !btnSync) return;
                
                statusBar.style.display = 'block';
                
                if (pendientes.length === 0) {
                    // Todo sincronizado
                    statusBar.className = 'sync-status-bar';
                    statusText.textContent = '‚úÖ Todos los reportes est√°n sincronizados';
                    statusBadge.textContent = `${sincronizados.length} en la nube`;
                    statusBadge.className = 'sync-badge';
                    btnSync.innerHTML = '‚úÖ Sincronizado';
                    btnSync.disabled = true;
                } else {
                    // Hay pendientes
                    statusBar.className = 'sync-status-bar warning';
                    statusText.textContent = `‚ö†Ô∏è Hay ${pendientes.length} reporte${pendientes.length > 1 ? 's' : ''} sin sincronizar`;
                    statusBadge.textContent = `${pendientes.length} pendiente${pendientes.length > 1 ? 's' : ''}`;
                    statusBadge.className = 'sync-badge warning';
                    btnSync.innerHTML = `‚òÅÔ∏è Sincronizar (${pendientes.length})`;
                    btnSync.disabled = false;
                }
                
                // Si no hay conexi√≥n
                if (!navigator.onLine) {
                    statusBar.className = 'sync-status-bar error';
                    statusText.textContent = 'üî¥ Sin conexi√≥n - Los reportes se sincronizar√°n cuando regrese la conexi√≥n';
                    statusBadge.textContent = 'Offline';
                    statusBadge.className = 'sync-badge error';
                    btnSync.innerHTML = 'üî¥ Sin conexi√≥n';
                    btnSync.disabled = true;
                }
                
            } catch (error) {
                console.error('Error actualizando estado de sincronizaci√≥n:', error);
            }
        }
        
        async function sincronizarReportesManual() {
            const btnSync = document.getElementById('btnSincronizar');
            const statusText = document.getElementById('syncStatusText');
            
            if (!navigator.onLine) {
                mostrarMensaje('‚ùå No hay conexi√≥n a internet', 'error');
                return;
            }
            
            // Cambiar estado del bot√≥n
            const textoOriginal = btnSync.innerHTML;
            btnSync.innerHTML = 'üîÑ Sincronizando...';
            btnSync.disabled = true;
            statusText.textContent = 'üîÑ Sincronizando reportes con Firebase...';
            
            try {
                // Inicializar Firebase si no est√° listo
                if (!sincronizador || !sincronizador.db) {
                    mostrarMensaje('‚è≥ Conectando con Firebase...', 'warning');
                    sincronizador = new SincronizadorFirebase();
                    sincronizador.usuarioActual = window.usuarioActual;
                    await sincronizador.inicializar();
                }
                
                // Sincronizaci√≥n bidireccional completa
                await sincronizador.sincronizarBidireccional();
                
                // Actualizar estado
                await actualizarEstadoSincronizacion();
                await cargarBorradores();
                
                // Mostrar resumen de sincronizaci√≥n
                const reportesLocales = await reportesDB.obtenerTodosLosReportes();
                const sincronizados = reportesLocales.filter(r => r.sincronizadoFirebase);
                mostrarMensaje(`‚úÖ Sincronizaci√≥n completada: ${sincronizados.length} reportes en la nube`, 'success');
                
            } catch (error) {
                console.error('Error en sincronizaci√≥n manual:', error);
                mostrarMensaje('‚ùå Error al sincronizar: ' + error.message, 'error');
                btnSync.innerHTML = textoOriginal;
                btnSync.disabled = false;
            }
        }
        
        // Actualizar estado cuando se carga la lista de borradores
        let cargarBorradoresOriginal = null;
        
        // Esperar a que la funci√≥n original est√© disponible
        setTimeout(() => {
            if (typeof cargarBorradores === 'function') {
                cargarBorradoresOriginal = cargarBorradores;
                window.cargarBorradores = async function() {
                    await cargarBorradoresOriginal();
                    await actualizarEstadoSincronizacion();
                };
            }
        }, 1000);
        
        // Actualizar estado cuando cambia la conexi√≥n
        window.addEventListener('online', () => {
            actualizarEstadoSincronizacion();
            mostrarMensaje('‚úÖ Conexi√≥n restaurada', 'success');
        });
        
        window.addEventListener('offline', () => {
            actualizarEstadoSincronizacion();
            mostrarMensaje('üî¥ Sin conexi√≥n', 'warning');
        });
        
    </script>

    <!-- Registro del Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(function(registration) {
                        console.log('‚úÖ Service Worker registrado exitosamente:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('‚ùå Error registrando Service Worker:', error);
                    });
            });
        }
    </script>

    <footer class="footer-leyenda">
        Herramienta de uso interno. Propiedad de <strong>University of Dayton Publishing</strong>. Su uso est√° restringido exclusivamente al personal autorizado.
    </footer>

</body>
</html>
